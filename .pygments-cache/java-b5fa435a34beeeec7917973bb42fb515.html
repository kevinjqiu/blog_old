<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainPresenter</span> <span class="kd">extends</span> <span class="n">WidgetPresenter</span><span class="o">&lt;</span><span class="n">MainPresenter</span><span class="o">.</span><span class="na">Display</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DispatchAsync</span> <span class="n">_dispatch</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">_logger</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">MainPresenter</span><span class="o">(</span><span class="kd">final</span> <span class="n">Display</span> <span class="n">display</span><span class="o">,</span> <span class="kd">final</span> <span class="n">EventBus</span> <span class="n">eventBus</span><span class="o">,</span> <span class="kd">final</span> <span class="n">DispatchAsync</span> <span class="n">dispatch</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ILog</span> <span class="n">logger</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">display</span><span class="o">,</span> <span class="n">eventBus</span><span class="o">);</span>
        <span class="n">_dispatch</span> <span class="o">=</span> <span class="n">dispatch</span><span class="o">;</span>
        <span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onBind</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">registerHandler</span><span class="o">(</span><span class="n">display</span><span class="o">.</span><span class="na">getFetchLatest</span><span class="o">().</span><span class="na">addClickHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ClickHandler</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="kd">final</span> <span class="n">ClickEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">fetchSellingRate</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}));</span>

        <span class="n">registerHandler</span><span class="o">(</span><span class="n">eventBus</span><span class="o">.</span><span class="na">addHandler</span><span class="o">(</span><span class="n">RateFetchedEvent</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="k">new</span> <span class="n">RateFetchedHandler</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRateFetched</span><span class="o">(</span><span class="kd">final</span> <span class="n">Rate</span> <span class="n">rate</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">saveRate</span><span class="o">(</span><span class="n">rate</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}));</span>

        <span class="n">registerHandler</span><span class="o">(</span><span class="n">eventBus</span><span class="o">.</span><span class="na">addHandler</span><span class="o">(</span><span class="n">RateSavedEvent</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="k">new</span> <span class="n">RateSavedHandler</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRateSaved</span><span class="o">(</span><span class="kd">final</span> <span class="n">Rate</span> <span class="n">rate</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">display</span><span class="o">.</span><span class="na">addToRecentRates</span><span class="o">(</span><span class="n">rate</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}));</span>

        <span class="n">registerHandler</span><span class="o">(</span><span class="n">display</span><span class="o">.</span><span class="na">getRefresh</span><span class="o">().</span><span class="na">addClickHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ClickHandler</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="kd">final</span> <span class="n">ClickEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">getLatestSavedRates</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}));</span>

        <span class="n">getLatestSavedRates</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">getLatestSavedRates</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">.</span><span class="na">setShowLoadingCurrentRate</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">GetRates</span> <span class="n">getRates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GetRates</span><span class="o">();</span>

        <span class="n">_dispatch</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">getRates</span><span class="o">,</span> <span class="k">new</span> <span class="n">AsyncCallback</span><span class="o">&lt;</span><span class="n">GetRatesResult</span><span class="o">&gt;()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">caught</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">display</span><span class="o">.</span><span class="na">setShowLoadingCurrentRate</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">_logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Unable to get saved rates: &quot;</span> <span class="o">+</span> <span class="n">caught</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="kd">final</span> <span class="n">GetRatesResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">display</span><span class="o">.</span><span class="na">setShowLoadingCurrentRate</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">display</span><span class="o">.</span><span class="na">clearRecentRates</span><span class="o">();</span>

                <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Rate</span> <span class="n">rate</span> <span class="o">:</span> <span class="n">result</span><span class="o">.</span><span class="na">getRates</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">display</span><span class="o">.</span><span class="na">addToRecentRates</span><span class="o">(</span><span class="n">rate</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="c1">// Put the latest rate in the box</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getRates</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">Rate</span> <span class="n">latestRate</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getRates</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                    <span class="n">display</span><span class="o">.</span><span class="na">getRateDisplayLabel</span><span class="o">().</span><span class="na">setText</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">latestRate</span><span class="o">.</span><span class="na">getRate</span><span class="o">()));</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>

    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">fetchSellingRate</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">.</span><span class="na">setShowLoadingCurrentRate</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">CheckRate</span> <span class="n">checkRate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CheckRate</span><span class="o">(</span><span class="n">RateType</span><span class="o">.</span><span class="na">Selling</span><span class="o">);</span>
        <span class="n">_dispatch</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">checkRate</span><span class="o">,</span> <span class="k">new</span> <span class="n">AsyncCallback</span><span class="o">&lt;</span><span class="n">CheckRateResult</span><span class="o">&gt;()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">caught</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">display</span><span class="o">.</span><span class="na">setShowLoadingCurrentRate</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="n">_logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Unable to fetch rate: &quot;</span> <span class="o">+</span> <span class="n">caught</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="kd">final</span> <span class="n">CheckRateResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">display</span><span class="o">.</span><span class="na">setShowLoadingCurrentRate</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="c1">// enable the fetch button</span>
                <span class="n">display</span><span class="o">.</span><span class="na">setEnabledFetchLatestButton</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">display</span><span class="o">.</span><span class="na">getRateDisplayLabel</span><span class="o">().</span><span class="na">setText</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getRate</span><span class="o">().</span><span class="na">getRate</span><span class="o">()));</span>
                <span class="n">eventBus</span><span class="o">.</span><span class="na">fireEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">RateFetchedEvent</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getRate</span><span class="o">()));</span>
            <span class="o">}</span>

        <span class="o">});</span>

        <span class="c1">// disable the fetch button until RPC succeeds</span>
        <span class="n">display</span><span class="o">.</span><span class="na">setEnabledFetchLatestButton</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">saveRate</span><span class="o">(</span><span class="kd">final</span> <span class="n">Rate</span> <span class="n">rate</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">SaveRate</span> <span class="n">saveRate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SaveRate</span><span class="o">(</span><span class="n">rate</span><span class="o">);</span>

        <span class="n">_dispatch</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">saveRate</span><span class="o">,</span> <span class="k">new</span> <span class="n">AsyncCallback</span><span class="o">&lt;</span><span class="n">SaveRateResult</span><span class="o">&gt;()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="kd">final</span> <span class="n">Throwable</span> <span class="n">caught</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">_logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Unable to save rate: &quot;</span> <span class="o">+</span> <span class="n">caught</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="kd">final</span> <span class="n">SaveRateResult</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">eventBus</span><span class="o">.</span><span class="na">fireEvent</span><span class="o">(</span><span class="k">new</span> <span class="n">RateSavedEvent</span><span class="o">(</span><span class="n">rate</span><span class="o">));</span>
            <span class="o">}</span>

        <span class="o">});</span>

    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">onPlaceRequest</span><span class="o">(</span><span class="kd">final</span> <span class="n">PlaceRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="n">onUnbind</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">refreshDisplay</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">revealDisplay</span><span class="o">()</span> <span class="o">{}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Place</span> <span class="n">getPlace</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></div>